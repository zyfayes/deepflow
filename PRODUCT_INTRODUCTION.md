# DeepFlow 产品详细介绍

> 本文档面向产品/运营人员，全面介绍 DeepFlow 项目的核心功能、业务流程和技术实现逻辑。

---

## 📋 目录

1. [产品概述](#产品概述)
2. [核心功能模块](#核心功能模块)
3. [业务流程](#业务流程)
4. [技术架构](#技术架构)
5. [关键特性](#关键特性)
6. [用户场景](#用户场景)
7. [数据存储与缓存](#数据存储与缓存)

---

## 产品概述

### 产品定位

**DeepFlow（深度心流）** 是一款面向青少年的"离线伴学"AI音频学习平台，核心理念是**反手机（Anti-Phone）& AI原生（AI Native）**。

- **Slogan**: 听见你的专注力 (Hear Your Focus)
- **目标用户**: 青少年学习者
- **核心价值**: 通过硬件形态切割娱乐（屏幕）和学习（音频），构建去屏化的心流场域

### 产品理念

- **手机是"补给站"**: 负责数据吞吐、视觉整理（上传材料、配置参数）
- **耳机和打印机是"战场"**: 负责执行、沉浸、输出（音频播放、实时对话、知识输出）

---

## 核心功能模块

### 1. Pack My Bag（一键打包）

**功能描述**: 将用户上传的各类学习材料转换为结构化的音频学习内容。

#### 支持的输入类型

- **图片文件**: 拍照上传（课本、试卷、笔记等）
- **PDF文件**: 电子文档导入
- **Word文档**: .doc/.docx 格式（自动转换为文本）
- **音频文件**: 语音备忘录（从耳机端录制）
- **文本内容**: 直接输入文本内容

#### 处理流程

1. **文件上传与识别**
   - 支持多文件同时上传
   - 自动识别文件类型（图片、PDF、Word、音频等）
   - 使用文件哈希值进行去重和缓存管理

2. **AI内容分析**
   - 使用 Google Gemini API 进行多模态内容分析
   - 支持图片OCR识别、PDF文本提取、音频转写
   - 根据文件类型和大小自动选择合适的Prompt模板

3. **内容生成策略**

   系统提供多种生成预设（Preset），用户可根据学习需求选择：

   - **速听精华（quick_summary）**: 
     - 时长：短（5-10分钟）
     - 模式：单人朗读
     - 类型：总结输出
     - 适用场景：快速复习、碎片时间学习

   - **深度剖析（deep_analysis）**:
     - 时长：长（15-30分钟）
     - 模式：双人对话（播客式）
     - 类型：深度讨论
     - 适用场景：系统学习、深入理解

   - **互动练习（interactive_practice）**:
     - 时长：中等
     - 模式：双人对话
     - 类型：互动式问答
     - 适用场景：知识巩固、测试练习

4. **脚本生成**
   - 生成结构化的对话脚本（包含speaker和text字段）
   - 提取关键知识点，自动生成知识卡片（KnowledgeCard）
   - 生成内容摘要（TLDR）和字幕时间轴

5. **知识卡片提取**
   - 从生成的内容中自动提取关键知识点
   - 每个知识卡片包含：标题、内容、标签、触发时间
   - 支持后续打印和复习

#### 技术实现

- **后端API**: `/api/analyze` (POST)
- **AI模型**: Gemini 3 Pro Preview
- **Prompt系统**: 基于文件类型和用户偏好自动选择Prompt模板
- **缓存机制**: 相同文件使用相同预设时，直接返回缓存结果

---

### 2. Go Flow 模式（心流播放）

**功能描述**: 用户进入沉浸式学习模式，播放生成的学习内容。

#### 模式类型

1. **音频播放模式（audio）**
   - 播放预生成的音频内容
   - 支持字幕同步显示
   - 支持播放进度记录（用于复盘）
   - 自动触发知识卡片打印（基于时间轴）

2. **实时对话模式（live）**
   - 基于 Gemini Live API 的实时语音对话
   - 用户可随时打断AI进行提问
   - AI根据对话内容动态生成知识卡片
   - 支持犹豫检测（用户沉默超过3秒或出现困惑表达时自动生成知识卡片）

#### 播放流程

1. **准备阶段**
   - 检查音频是否已生成
   - 如未生成，创建TTS任务并轮询状态
   - 加载字幕和时间轴数据

2. **播放阶段**
   - 音频播放（HLS流或本地文件）
   - 字幕同步显示
   - 播放进度实时记录

3. **交互阶段**（实时对话模式）
   - 麦克风输入采集
   - 实时语音转文本（STT）
   - AI响应生成（TTS）
   - 双向音频流传输

#### 技术实现

- **TTS生成**: 
  - 优先使用 ListenHub API（高质量语音合成）
  - 降级使用 Google TTS API
  - 支持异步任务模式（长音频生成）
  
- **实时对话**:
  - WebSocket 连接（`/api/live-session`）
  - Gemini Live API（Native Audio模式）
  - 音频格式：24kHz PCM
  - 语音模型：gemini-2.5-flash-native-audio-preview

- **进度记录**:
  - 记录每次播放的开始时间、结束时间、总时长
  - 计算播放进度百分比
  - 用于"今日复盘"功能

---

### 3. 场景系统（Scene System）

**功能描述**: 根据不同的学习场景，提供匹配的背景效果、音频提示和内容推荐。

#### 支持的场景类型

1. **回家路上（commute）**
   - 背景效果：雪夜城市动画
   - 音频提示：通勤场景提示音
   - 适用内容：轻量级复习、播客式内容

2. **在家充电（home_charge）**
   - 背景效果：无
   - 适用内容：放松、恢复性学习

3. **静坐专注（focus）**
   - 背景效果：图书馆氛围动画
   - 音频提示：学习场景提示音
   - 适用内容：深度学习、系统化内容

4. **睡前冥想（sleep_meditation）**
   - 背景效果：夜晚静谧动画
   - 音频提示：睡前放松提示音
   - 适用内容：轻松回顾、冥想引导

5. **问答式记忆（qa_memory）**
   - 背景效果：图书馆氛围
   - 适用内容：知识巩固、记忆强化

6. **今日复盘（daily_review）**
   - 背景效果：图书馆氛围
   - 功能：基于当日学习内容生成复盘总结

#### 场景切换逻辑

- 用户可通过"环境"按钮循环切换场景
- 场景切换时自动播放对应的音频提示
- 激活场景后自动触发背景效果
- 不同场景推荐不同的内容类型和播放模式

---

### 4. 知识卡片系统（Knowledge Card System）

**功能描述**: 自动提取和管理学习中的关键知识点，支持打印和复习。

#### 知识卡片生成方式

1. **内容分析生成**
   - 在 Pack My Bag 阶段，AI分析内容时自动提取
   - 基于内容重要性、概念密度自动生成
   - 每个卡片关联到音频播放的时间点

2. **实时对话生成**
   - 在实时对话模式下，AI检测到以下情况时自动生成：
     - 用户犹豫（沉默超过3秒、说话卡壳、困惑表达）
     - 重要知识点（公式、定义、易错点）
   - 使用 Gemini 函数调用（Function Call）机制
   - 函数名：`autoPrintNote`

#### 知识卡片格式

```typescript
{
  id: string;           // 唯一标识
  title: string;        // 卡片标题（如"虚拟语气"、"勾股定理"）
  content: string;      // 具体内容（定义、公式、解释等）
  tags: string[];       // 标签数组（如["英语", "语法"]）
  timestamp: Date;      // 创建时间
  triggerTime?: number; // 在音频中的触发时间（秒）
  source?: 'generated' | 'ai_realtime'; // 来源标识
}
```

#### 知识卡片展示

- **知识花园（Garden Tab）**: 所有知识卡片的可视化展示
- **卡片列表**: 支持按标签筛选、搜索
- **打印功能**: 点击卡片可触发打印机打印

---

### 5. 打印机联动（Printer Integration）

**功能描述**: 将音频内容中的知识点打印成物理小票，实现"音纸同步"。

#### 打印触发方式

1. **自动打印（Auto-Print）**
   - 音频播放到关键知识点时自动触发
   - 基于知识卡片的 `triggerTime` 字段
   - 实时对话模式下，AI生成知识卡片时立即打印

2. **手动打印（Click-to-Print）**
   - 用户在播放过程中点击打印机按钮
   - 根据当前模式执行不同逻辑：
     - **Demo模式**: 打印预设的演示内容
     - **音频模式**: 打印第一个未打印的知识卡片
     - **实时对话模式**: 总结最近的对话内容并打印

3. **对话总结打印**
   - 在实时对话模式下，点击打印按钮可总结最近20条对话
   - 调用 `/api/summarize-conversation` API
   - 生成总结卡片并打印

#### 打印内容格式

- 标题（居中）
- 内容（多行文本）
- 标签（可选）
- 来源标记（如"Source: 实时对话"）

#### 打印动画

- 模拟热敏打印机出纸效果
- 支持多张小票堆叠显示
- 每张小票显示打印时间戳

---

### 6. 激励体系（Reward System）

**功能描述**: 通过游戏化机制激励用户持续学习，培养学习习惯。

#### 核心指标

1. **累计时长（Total Duration）**
   - 记录所有Go Flow会话的总时长
   - 单位为秒，前端格式化显示（小时/分钟）

2. **总积分（Total Points）**
   - 根据学习时长和完成情况计算
   - 完成会话获得基础积分
   - 连续学习获得额外奖励

3. **完成率（Completion Rate）**
   - 计算公式：`(总次数 - 中断次数) / 总次数 * 100%`
   - 反映用户的学习坚持度

4. **总次数（Total Sessions）**
   - 记录所有Go Flow会话的次数

5. **分心次数（Distraction Count）**
   - 记录用户在会话中切换应用、解锁手机等分心行为

#### 森林养成游戏

- **核心机制**: 根据累计学习时长，虚拟森林中的树木逐渐成长
- **成长阶段**: 
  - 0-30分钟：种子/幼苗
  - 30-60分钟：小树
  - 1-2小时：中型树
  - 2-4小时：大树
  - 4小时以上：参天大树/森林
- **视觉效果**: 使用 Three.js 渲染3D森林场景
- **成就展示**: 展示不同成长阶段的树木模型

#### 会话记录

- 记录每次Go Flow会话的详细信息：
  - 开始时间、结束时间
  - 实际时长
  - 是否中断
  - 分心次数
  - 获得的积分
- 保留最近100条会话记录
- 支持查看历史会话列表

#### 数据存储

- 使用 localStorage 存储所有统计数据
- 存储键：`deepflow_reward_data`
- 数据结构包含总统计和会话列表

---

### 7. 今日复盘（Daily Review）

**功能描述**: 基于用户当天的学习内容，自动生成一份总结性的复盘音频。

#### 复盘内容生成

1. **数据收集**
   - 收集当天所有播放过的 FlowItem
   - 提取播放进度、内容摘要、对话内容
   - 收集当天生成的所有知识卡片

2. **AI生成复盘脚本**
   - 调用 `/api/review` API
   - 使用 Gemini 2.0 Flash 模型
   - 生成对话式的复盘总结，包括：
     - 今天学习内容的简要回顾
     - 学习进度和完成情况
     - 重点知识点的强化记忆
     - 学习建议和下一步行动

3. **音频生成与播放**
   - 将复盘脚本转换为音频（TTS）
   - 添加到 FlowList 作为新的 FlowItem
   - 用户可随时播放复盘内容

#### 触发时机

- 用户在"今日复盘"场景中点击播放
- 系统自动检测是否已有当日复盘，避免重复生成

---

### 8. 缓存系统（Cache System）

**功能描述**: 智能缓存机制，减少重复计算和网络请求，提升用户体验。

#### 缓存层级

1. **文件缓存（File Cache）**
   - 使用 IndexedDB 存储上传的文件
   - 基于文件内容哈希值（MD5）去重
   - 缓存键：文件哈希值
   - 过期时间：30天

2. **内容缓存（FlowItem Cache）**
   - 使用 localStorage 存储分析结果
   - 缓存键：`flowitem_{fileHash}_{preset}`
   - 存储内容：完整的 FlowItem 对象（包含script、knowledgeCards等）
   - 过期时间：30天

3. **音频缓存（Audio Cache）**
   - 使用 IndexedDB 存储生成的音频文件
   - 缓存键：`audio_{scriptHash}_{preset}`
   - 存储内容：音频 Blob 对象
   - 过期时间：30天

#### 缓存策略

- **读取优先级**: 
  1. 先检查内容缓存（FlowItem）
  2. 如存在，直接使用，无需重新分析
  3. 如需音频，检查音频缓存
  4. 如音频存在，直接播放；如不存在，仅生成音频

- **写入策略**:
  - 文件上传后立即缓存
  - 内容分析完成后缓存 FlowItem
  - 音频生成完成后缓存音频 Blob

- **缓存清理**:
  - 自动清理超过30天的缓存
  - 用户可手动清理所有缓存
  - 支持查看缓存统计（文件数、音频数、元数据数）

#### 技术实现

- **IndexedDB**: 存储大文件（原始文件、音频Blob）
- **localStorage**: 存储结构化数据（FlowItem、统计数据）
- **哈希算法**: 使用 Web Crypto API 计算文件哈希

---

## 业务流程

### 完整学习流程

```
1. 材料上传（Pack My Bag）
   ↓
   用户上传图片/PDF/音频/文本
   ↓
   AI分析内容，生成脚本和知识卡片
   ↓
   生成音频（TTS）
   ↓
   
2. 进入Go Flow模式
   ↓
   选择场景（通勤/专注/睡前等）
   ↓
   选择播放内容
   ↓
   
3. 播放学习
   ├─ 音频模式：播放预生成音频 + 字幕
   └─ 实时对话模式：与AI实时交互
   ↓
   
4. 知识沉淀
   ├─ 自动打印关键知识点
   └─ 手动打印感兴趣的内容
   ↓
   
5. 今日复盘
   ↓
   AI生成当日学习总结
   ↓
   播放复盘音频
```

### 关键交互流程

#### 场景切换流程

1. 用户点击"环境"按钮
2. 系统检测可用的场景（有背景效果的场景）
3. 循环切换到下一个场景
4. 播放场景对应的音频提示
5. 激活背景动画效果
6. 如果当前有可播放内容，自动开始播放

#### 实时对话流程

1. 用户选择"实时对话"模式
2. 系统建立 WebSocket 连接
3. 初始化 Gemini Live API 会话
4. 发送用户脚本和知识卡片上下文
5. AI开始对话，用户可随时打断
6. 检测到用户犹豫或重要知识点时，AI调用函数生成知识卡片
7. 知识卡片自动打印
8. 对话结束后，可总结对话内容

#### 知识卡片打印流程

1. **自动打印**:
   - 音频播放到知识卡片的 triggerTime
   - 触发打印事件
   - 打印机组件显示打印动画

2. **手动打印（音频模式）**:
   - 用户点击打印机按钮
   - 找到第一个未打印的知识卡片
   - 触发打印

3. **手动打印（实时对话模式）**:
   - 用户点击打印机按钮
   - 收集最近20条对话历史
   - 调用总结API生成总结卡片
   - 触发打印

---

## 技术架构

### 前端技术栈

- **框架**: React 19 + TypeScript
- **构建工具**: Vite 7
- **UI库**: 
  - Tailwind CSS 4（样式）
  - Framer Motion（动画）
  - Lucide React（图标）
- **3D渲染**: Three.js（森林场景）
- **音频处理**: 
  - HLS.js（流媒体播放）
  - Web Audio API（实时音频处理）
- **状态管理**: React Hooks（useState、useEffect等）
- **数据存储**: 
  - IndexedDB（大文件、音频）
  - localStorage（元数据、统计数据）

### 后端技术栈

- **运行时**: Node.js
- **框架**: Express.js
- **部署方式**: 
  - 独立服务器（Express）
  - Vercel Serverless Functions（无服务器）
- **AI服务**: 
  - Google Gemini API（内容分析、对话）
  - Gemini Live API（实时语音对话）
- **TTS服务**: 
  - ListenHub API（高质量语音合成）
  - Google TTS API（降级方案）
- **文件处理**: 
  - formidable（文件上传）
  - mammoth（Word文档转换）
  - word-extractor（旧版Word文档）

### API端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/analyze` | POST | 文件分析和内容生成 |
| `/api/tts` | POST | 创建TTS生成任务 |
| `/api/tts` | GET | 查询TTS任务状态 |
| `/api/live-session` | POST | 创建实时对话会话 |
| `/api/review` | POST | 生成今日复盘 |
| `/api/summarize-conversation` | POST | 总结对话内容 |
| `/api/proxy-audio` | GET | 代理音频文件（CORS） |
| `/health` | GET | 健康检查 |

### 数据流

```
前端 (React)
  ↓ HTTP/WebSocket
后端 (Express/Vercel)
  ↓ API调用
外部服务 (Gemini/ListenHub/TTS)
  ↓ 响应数据
后端处理
  ↓ 返回结果
前端展示/缓存
```

---

## 关键特性

### 1. 多模态内容理解

- 支持图片、PDF、Word、音频、文本等多种输入格式
- 使用 Gemini 3 Pro 的多模态能力进行统一分析
- 自动提取文本、识别图像内容、转写音频

### 2. 智能内容生成

- 根据文件类型和用户偏好自动选择生成策略
- 支持多种预设模式（速听、深度、对话、互动）
- 生成结构化的对话脚本，便于TTS合成

### 3. 高质量语音合成

- 优先使用 ListenHub API（专业播客级质量）
- 支持双人对话模式（不同说话人）
- 降级到 Google TTS（保证可用性）

### 4. 实时交互学习

- 基于 Gemini Live API 的低延迟对话
- 支持随时打断、自然对话
- 智能检测用户状态（犹豫、困惑）并提供帮助

### 5. 知识提取与管理

- 自动提取关键知识点
- 支持时间轴关联（知识点在音频中的位置）
- 实时对话中动态生成知识卡片

### 6. 场景化学习体验

- 多种学习场景（通勤、专注、睡前等）
- 场景匹配的背景效果和音频提示
- 场景推荐合适的内容类型

### 7. 游戏化激励

- 累计时长统计
- 积分系统
- 森林养成游戏（可视化成长）
- 会话记录和完成率追踪

### 8. 智能缓存

- 多层级缓存（文件、内容、音频）
- 基于内容哈希的去重
- 自动过期清理
- 显著减少重复计算和网络请求

---

## 用户场景

### 场景1：碎片时间复习

**用户需求**: 利用通勤时间复习昨天的课程内容

**操作流程**:
1. 上传昨天课堂笔记的照片
2. 选择"速听精华"预设
3. 进入"回家路上"场景
4. 播放生成的音频内容
5. 听到关键知识点时，自动打印小票
6. 到达目的地后，查看打印的小票复习

### 场景2：深度理解新概念

**用户需求**: 深入理解一个复杂的数学概念

**操作流程**:
1. 上传包含该概念的教材PDF
2. 选择"深度剖析"预设
3. 进入"静坐专注"场景
4. 播放双人对话式的深度讲解
5. 遇到不懂的地方，切换到"实时对话"模式
6. 与AI实时交流，获得个性化解答
7. AI检测到困惑时，自动生成知识卡片并打印

### 场景3：睡前回顾

**用户需求**: 睡前轻松回顾今天学到的知识点

**操作流程**:
1. 进入"今日复盘"场景
2. 系统自动生成当天的学习总结
3. 播放轻松舒缓的复盘音频
4. 在放松的氛围中巩固知识

### 场景4：互动练习

**用户需求**: 通过问答方式巩固英语语法

**操作流程**:
1. 上传英语错题图片
2. 选择"互动练习"预设
3. 进入"问答式记忆"场景
4. 启动"实时对话"模式
5. AI提问，用户回答
6. AI实时反馈，纠正错误
7. 重要知识点自动打印，便于后续复习

---

## 数据存储与缓存

### 存储结构

#### IndexedDB 数据库（deepflow_cache）

1. **files 表**
   - 存储：上传的原始文件（Blob）
   - 索引：cachedAt（创建时间）
   - 用途：文件缓存，避免重复上传

2. **audio 表**
   - 存储：生成的音频文件（Blob）
   - 索引：cachedAt、scriptHash
   - 用途：音频缓存，避免重复生成

#### localStorage

1. **FlowItem 缓存**
   - 键格式：`flowitem_{fileHash}_{preset}`
   - 值：FlowItem JSON对象
   - 用途：内容分析结果缓存

2. **激励数据**
   - 键：`deepflow_reward_data`
   - 值：RewardData JSON对象
   - 包含：统计数据和会话记录

### 缓存策略总结

| 数据类型 | 存储位置 | 缓存键 | 过期时间 |
|---------|---------|--------|---------|
| 原始文件 | IndexedDB | 文件哈希 | 30天 |
| 分析结果 | localStorage | flowitem_{hash}_{preset} | 30天 |
| 音频文件 | IndexedDB | audio_{scriptHash}_{preset} | 30天 |
| 统计数据 | localStorage | deepflow_reward_data | 永久 |

### 缓存命中流程

```
用户上传文件
  ↓
计算文件哈希
  ↓
检查文件缓存 → 命中？→ 直接使用
  ↓ 未命中
上传并缓存文件
  ↓
检查内容缓存 → 命中？→ 直接使用
  ↓ 未命中
调用AI分析，生成内容
  ↓
缓存分析结果
  ↓
检查音频缓存 → 命中？→ 直接播放
  ↓ 未命中
生成音频（TTS）
  ↓
缓存音频文件
  ↓
播放音频
```

---

## 总结

DeepFlow 是一个完整的AI驱动的学习平台，核心特点包括：

1. **多模态输入**: 支持图片、PDF、Word、音频等多种格式
2. **智能生成**: 根据内容和场景生成合适的学习材料
3. **沉浸式体验**: 场景化的背景效果和音频提示
4. **实时交互**: 基于语音的实时对话学习
5. **知识沉淀**: 自动提取和打印关键知识点
6. **游戏化激励**: 通过养成游戏激励持续学习
7. **智能缓存**: 多层级缓存提升性能和用户体验

整个系统设计注重用户体验，通过去屏化的音频学习方式，帮助用户建立专注的学习习惯，同时通过游戏化和知识沉淀机制，提升学习效果和持续性。

